<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel - M√≠stnosti</title>
    <!-- Odkaz na sd√≠len√Ω CSS soubor -->
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
</head>
<body>

    <!-- NAVIGACE -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">Monitorovac√≠ Syst√©m</a>
        <div class="nav-links">
            <a href="teplomer.html" class="nav-btn active">M√≠stnosti</a>
            <a href="kotelna.html" class="nav-btn">Kotelna</a>
        </div>
    </nav>

    <div class="container">
        <div id="status">P≈ôipojov√°n√≠ k ThingSpeak MQTT...</div>
        <br>

        <!-- GRID PRO KARTY M√çSTNOST√ç -->
        <div id="dashboard-rooms" class="dashboard-grid">
            <!-- Karty se generuj√≠ automaticky p≈ôes JS -->
        </div>

        <!-- GRAF -->
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURACE THINGSPEAK ---
        // ZDE ZADEJTE SV√â √öDAJE
        const tsConfig = {
            channelID: '3011617', 
            readKey: 'BMX38S8R8XSRK5YR'
        };

        // --- 2. KONFIGURACE SENZOR≈Æ PRO M√çSTNOSTI ---
        // Nyn√≠ mapujeme senzory na "Fields" v ThingSpeak kan√°lu
        const senzorKonfig = [
            { 
                id: 'obyvak', 
                nazev: 'Ob√Ωv√°k', 
                fieldTemp: 'field1', // Teplota je v grafu 1
                fieldHum: 'field2',  // Vlhkost je v grafu 2
                color: '#3498db'
            }
            // Zde m≈Ø≈æete p≈ôidat dal≈°√≠ m√≠stnosti mapovan√© na field3, field4 atd.
        ];

        // --- 3. GENERUJ HTML KARTY ---
        const dashboardRooms = document.getElementById('dashboard-rooms');
        senzorKonfig.forEach(senzor => {
            const html = `
                <div class="card" style="border-top-color: ${senzor.color}">
                    <span class="card-icon">üè†</span>
                    <h2>${senzor.nazev}</h2>
                    <div class="data-row">
                        <span class="data-label">Teplota</span>
                        <div><span id="val-temp-${senzor.id}" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Vlhkost</span>
                        <div><span id="val-hum-${senzor.id}" class="data-value">--</span> <span class="data-unit">%</span></div>
                    </div>
                </div>
            `;
            dashboardRooms.innerHTML += html;
        });

        // --- 4. INICIALIZACE GRAFU ---
        const ctx = document.getElementById('tempChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: senzorKonfig.map(s => ({
                    label: s.nazev,
                    borderColor: s.color,
                    backgroundColor: s.color,
                    data: [], 
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0, 
                    pointHitRadius: 10
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour', tooltipFormat: 'HH:mm' },
                        title: { display: true, text: 'ƒåas' }
                    },
                    y: { suggestedMin: 18, suggestedMax: 28 }
                },
                plugins: { 
                    title: { display: true, text: 'V√Ωvoj teplot (Data z ThingSpeak)' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });

        // --- 5. MQTT LOGIKA (ThingSpeak Broker) ---
        // ThingSpeak MQTT WebSocket bƒõ≈æ√≠ na wss://mqtt.thingspeak.com
        const mqttOptions = {
            protocol: 'wss',
            hostname: 'mqtt.thingspeak.com',
            port: 443,
            clientId: 'WebClient_' + Math.random().toString(16).substr(2, 8),
            // Pro ve≈ôejn√© kan√°ly nen√≠ nutn√© jm√©no/heslo.
            // Pro priv√°tn√≠ kan√°ly m≈Ø≈æe b√Ωt pot≈ôeba 'username' a 'password' (v√°≈° MQTT API Key z profilu).
            clean: true
        };

        const client = mqtt.connect(mqttOptions);
        const statusEl = document.getElementById('status');

        client.on('connect', () => {
            if (tsConfig.channelID === '3011617') {
                statusEl.innerHTML = '<span style="color:red">Chyb√≠ nastaven√≠ Channel ID!</span>';
                return;
            }
            
            statusEl.innerHTML = '<span class="online">‚óè P≈ôipojeno k ThingSpeak MQTT</span>';
            
            // Odbƒõr cel√©ho kan√°lu (v≈°echny fields najednou)
            // Form√°t: channels/<channelID>/subscribe
            const topic = `channels/${tsConfig.channelID}/subscribe`;
            client.subscribe(topic);
            console.log("Odeb√≠r√°m topic:", topic);
        });

        client.on('message', (topic, message) => {
            try {
                // ThingSpeak pos√≠l√° data jako JSON objekt
                // P≈ô√≠klad: {"created_at":"2025-01-01T12:00:00Z", "field1":"22.5", "field2":"45"}
                const data = JSON.parse(message.toString());
                const now = new Date(data.created_at || new Date());

                senzorKonfig.forEach((s, index) => {
                    // Zpracov√°n√≠ teploty (pokud p≈ôi≈°la v payloadu)
                    if (data[s.fieldTemp] !== undefined) {
                        const tempVal = parseFloat(data[s.fieldTemp]);
                        
                        // Aktualizace ƒç√≠sla na kartƒõ
                        const elTemp = document.getElementById(`val-temp-${s.id}`);
                        if(elTemp) {
                            elTemp.innerText = tempVal.toFixed(1);
                            // Efekt bliknut√≠ pro aktualizaci
                            elTemp.style.color = '#e67e22'; 
                            setTimeout(() => elTemp.style.color = '', 500);
                        }

                        // P≈ôid√°n√≠ do grafu
                        myChart.data.datasets[index].data.push({x: now, y: tempVal});
                    }

                    // Zpracov√°n√≠ vlhkosti
                    if (data[s.fieldHum] !== undefined) {
                        const humVal = parseFloat(data[s.fieldHum]);
                        const elHum = document.getElementById(`val-hum-${s.id}`);
                        if(elHum) elHum.innerText = humVal.toFixed(0);
                    }
                });

                // Posun grafu, aby nebyl p≈ôeplnƒõn√Ω
                senzorKonfig.forEach((s, index) => {
                     if (myChart.data.datasets[index].data.length > 200) {
                        myChart.data.datasets[index].data.shift();
                    }
                });
                myChart.update('none');

            } catch (e) {
                console.error("Chyba p≈ôi zpracov√°n√≠ MQTT zpr√°vy:", e);
            }
        });

        client.on('error', (err) => { 
            console.error(err); 
            statusEl.innerText = 'Chyba spojen√≠ s ThingSpeak MQTT'; 
            statusEl.style.color = 'red';
        });

        // --- 6. NAƒåTEN√ç HISTORIE (REST API) ---
        // Toto se spust√≠ p≈ôi naƒçten√≠ str√°nky, aby graf nebyl pr√°zdn√Ω
        async function loadHistory() {
            if (tsConfig.channelID === '3011617') return;

            const url = `https://api.thingspeak.com/channels/${tsConfig.channelID}/feeds.json?api_key=${tsConfig.readKey}&results=100`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.feeds) {
                    // Vymaz√°n√≠ star√Ωch dat p≈ôed naƒçten√≠m historie
                    myChart.data.datasets.forEach(ds => ds.data = []);

                    data.feeds.forEach(feed => {
                        const time = new Date(feed.created_at);
                        senzorKonfig.forEach((senzor, index) => {
                            const val = parseFloat(feed[senzor.fieldTemp]);
                            if (!isNaN(val)) {
                                myChart.data.datasets[index].data.push({x: time, y: val});
                            }
                            
                            // Nastaven√≠ posledn√≠ zn√°m√© hodnoty do karet (aby tam nebylo --)
                            const lastTemp = parseFloat(feed[senzor.fieldTemp]);
                            const lastHum = parseFloat(feed[senzor.fieldHum]);
                            
                            if(!isNaN(lastTemp)) document.getElementById(`val-temp-${senzor.id}`).innerText = lastTemp.toFixed(1);
                            if(!isNaN(lastHum)) document.getElementById(`val-hum-${senzor.id}`).innerText = lastHum.toFixed(0);
                        });
                    });
                    myChart.update();
                }
            } catch (error) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ historie:", error);
            }
        }

        // Spustit naƒçten√≠ historie
        loadHistory();

    </script>
</body>
</html>