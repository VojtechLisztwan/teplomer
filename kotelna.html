<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel - Kotelna</title>
    <!-- Odkaz na sd√≠len√Ω CSS soubor -->
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- Knihovny pro graf -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <style>
        /* Specifick√© styly pro ovl√°d√°n√≠ grafu */
        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .range-btn {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            color: #2c3e50;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .range-btn:hover {
            background-color: #dfe6e9;
            transform: translateY(-1px);
        }

        .range-btn.active {
            background-color: #3498db; /* Primary blue */
            color: white;
            border-color: #3498db;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }
    </style>
</head>
<body>

    <!-- NAVIGACE -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">Monitorovac√≠ Syst√©m</a>
        <div class="nav-links">
            <a href="teplomer.html" class="nav-btn">M√≠stnosti</a>
            <a href="kotelna.html" class="nav-btn active">Kotelna</a>
        </div>
    </nav>

    <div class="container">
        <div id="status">P≈ôipojov√°n√≠ k MQTT...</div>
        <br>

        <!-- GRID PRO KOTELNU (≈Ωiv√° data) -->
        <div class="dashboard-grid">
                
            <!-- Karta: Kotel -->
            <div class="card card-boiler">
                <span class="card-icon">üî•</span>
                <h2>Hlavn√≠ Kotel</h2>
                <div class="data-row">
                    <span class="data-label">Teplota Pece</span>
                    <div>
                        <span id="val-pec" class="data-value">--</span> <span class="data-unit">¬∞C</span>
                    </div>
                </div>
            </div>

            <!-- Karta: Nov√Ω Bojler -->
            <div class="card">
                <span class="card-icon">üíß</span>
                <h2>Nov√Ω Bojler</h2>
                <div class="data-row">
                    <span class="data-label">Horn√≠</span>
                    <div><span id="val-horni_n" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                </div>
                <div class="data-row">
                    <span class="data-label">St≈ôedn√≠</span>
                    <div><span id="val-stredni_n" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                </div>
                <div class="data-row">
                    <span class="data-label">Doln√≠</span>
                    <div><span id="val-dolni_n" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                </div>
            </div>

            <!-- Karta: Star√Ω Bojler -->
            <div class="card card-old">
                <span class="card-icon">üèöÔ∏è</span>
                <h2>Star√Ω Bojler</h2>
                <div class="data-row">
                    <span class="data-label">Horn√≠</span>
                    <div><span id="val-horni_s" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                </div>
                <div class="data-row">
                    <span class="data-label">Doln√≠</span>
                    <div><span id="val-dolni_s" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                </div>
            </div>

            <!-- Karta: Sol√°rn√≠ Panel -->
            <div class="card card-solar">
                <span class="card-icon">‚òÄÔ∏è</span>
                <h2>Sol√°rn√≠ Panel</h2>
                <div class="data-row">
                    <span class="data-label">Teplota kolektoru</span>
                    <div>
                        <span id="val-solarni" class="data-value">--</span> <span class="data-unit">¬∞C</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- NOV√â: Sekce pro Graf -->
        <div class="chart-container">
            <!-- Ovl√°dac√≠ tlaƒç√≠tka pro ƒçasov√© obdob√≠ -->
            <div class="chart-controls">
                <button onclick="changeRange(360, this)" class="range-btn">6h</button>
                <button onclick="changeRange(720, this)" class="range-btn">12h</button>
                <button onclick="changeRange(1440, this)" class="range-btn active">24h</button>
                <button onclick="changeRange(4320, this)" class="range-btn">3 Dny</button>
            </div>
            
            <div style="position: relative; height: 340px;"> <!-- Obal pro canvas pro lep≈°√≠ kontrolu v√Ω≈°ky -->
                <canvas id="kotelnaChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        // --- 1. KONFIGURACE THINGSPEAK ---
        const tsConfig = {
            channelID: '3229890', 
            readKey: 'WB281UEYF211LC92'
        };

        // --- 2. DEFINICE DAT PRO GRAF ---
        // Mapov√°n√≠ pol√≠ (field1..7) na n√°zvy a barvy
        const datasetsConfig = [
            { field: 'field1', label: 'Pec', color: '#e74c3c' },        // ƒåerven√°
            { field: 'field2', label: 'Bojler N-Horn√≠', color: '#3498db' }, // Modr√°
            { field: 'field3', label: 'Bojler N-St≈ôed', color: '#5dade2' }, // Svƒõtle modr√°
            { field: 'field4', label: 'Bojler N-Doln√≠', color: '#85c1e9' }, // Bledƒõ modr√°
            { field: 'field5', label: 'Bojler S-Horn√≠', color: '#7f8c8d' }, // ≈†ed√°
            { field: 'field6', label: 'Bojler S-Doln√≠', color: '#bdc3c7' }, // Svƒõtle ≈°ed√°
            { field: 'field7', label: 'Sol√°r', color: '#f39c12' }           // Oran≈æov√°
        ];

        // --- 3. INICIALIZACE GRAFU ---
        const ctx = document.getElementById('kotelnaChart').getContext('2d');
        const chartData = {
            datasets: datasetsConfig.map(ds => ({
                label: ds.label,
                borderColor: ds.color,
                backgroundColor: ds.color,
                data: [], 
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
                pointHitRadius: 10
            }))
        };

        const myChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'HH:mm' }, title: {display: true, text: 'ƒåas'} },
                    y: { title: {display: true, text: 'Teplota (¬∞C)'} }
                },
                plugins: {
                    title: { display: true, text: 'Historie teplot v kotelnƒõ' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });

        // --- 4. NAƒåTEN√ç DAT Z THINGSPEAK ---
        // resultCount = poƒçet z√°znam≈Ø (p≈ôi 1 min intervalu: 360 = 6h, 1440 = 24h)
        async function loadHistory(resultCount = 1440) {
            if(tsConfig.channelID === 'VLOZTE_ID_KANALU') { console.log("Nenastaveno ID kan√°lu"); return; }
            
            // Indikace naƒç√≠t√°n√≠ v titulku grafu
            myChart.options.plugins.title.text = 'Naƒç√≠t√°m data...';
            myChart.update('none');

            const url = `https://api.thingspeak.com/channels/${tsConfig.channelID}/feeds.json?api_key=${tsConfig.readKey}&results=${resultCount}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Vyƒçistit star√° data p≈ôed naƒçten√≠m nov√Ωch
                myChart.data.datasets.forEach(ds => ds.data = []);

                if (data.feeds) {
                    data.feeds.forEach(feed => {
                        const time = new Date(feed.created_at);
                        
                        // Projdeme v≈°echny nadefinovan√© datasety (Pec, Bojlery...)
                        datasetsConfig.forEach((ds, index) => {
                            // ds.field je 'field1', 'field2' atd.
                            const val = parseFloat(feed[ds.field]);
                            if(!isNaN(val)) {
                                myChart.data.datasets[index].data.push({x: time, y: val});
                            }
                        });
                    });
                    
                    // Aktualizace titulku a grafu
                    myChart.options.plugins.title.text = `Historie teplot (posledn√≠ch ${data.feeds.length} z√°znam≈Ø)`;
                    myChart.update();
                }
            } catch (e) { 
                console.error("Chyba stahov√°n√≠ historie:", e); 
                myChart.options.plugins.title.text = 'Chyba p≈ôi naƒç√≠t√°n√≠ dat';
                myChart.update();
            }
        }

        // Funkce pro zmƒõnu rozsahu (tlaƒç√≠tka)
        function changeRange(count, btn) {
            // Aktualizace vzhledu tlaƒç√≠tek
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Naƒçten√≠ dat
            loadHistory(count);
        }

        // Spustit naƒç√≠t√°n√≠ (default 24h)
        loadHistory(1440);

        // --- 5. MQTT LOGIKA (≈ΩIV√Å DATA) ---
        const heatingMap = {
            'pec': 'val-pec',
            'horni_n': 'val-horni_n',
            'stredni_n': 'val-stredni_n',
            'dolni_n': 'val-dolni_n',
            'horni_s': 'val-horni_s',
            'dolni_s': 'val-dolni_s',
            'solarni': 'val-solarni'
        };

        const mqttOptions = {
            protocol: 'wss',
            hostname: 'broker.emqx.io', 
            port: 8084,
            path: '/mqtt',
            clientId: 'WebMonitor_Heat_' + Math.random().toString(16).substr(2, 8)
        };

        const client = mqtt.connect(mqttOptions);
        const statusEl = document.getElementById('status');

        client.on('connect', () => {
            statusEl.innerHTML = '<span class="online">‚óè Online - Kotelna</span>';
            Object.keys(heatingMap).forEach(topic => client.subscribe(topic));
        });

        client.on('message', (topic, message) => {
            if (heatingMap[topic]) {
                const msgVal = parseFloat(message.toString());
                const elementId = heatingMap[topic];
                const el = document.getElementById(elementId);
                
                if (el) {
                    el.innerText = msgVal.toFixed(1);
                    el.style.color = '#3498db';
                    setTimeout(() => el.style.color = '', 300);
                }
            }
        });

        client.on('error', (err) => { 
            console.error(err); 
            statusEl.innerText = 'Chyba spojen√≠ s MQTT'; 
            statusEl.style.color = 'red';
        });
    </script>
</body>
</html>