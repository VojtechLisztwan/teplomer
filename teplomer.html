<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel - M칤stnosti</title>
    <!-- Odkaz na sd칤len칳 CSS soubor -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Knihovny pro graf (MQTT odstran캩no) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
</head>
<body>

    <!-- NAVIGACE -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">Monitorovac칤 Syst칠m</a>
        <div class="nav-links">
            <a href="teplomer.html" class="nav-btn active">M칤stnosti</a>
            <a href="kotelna.html" class="nav-btn">Kotelna</a>
        </div>
    </nav>

    <div class="container">
        <!-- Status bar pro informaci o posledn칤 aktualizaci -->
        <div id="status" style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">
            Na캜칤t치m data...
        </div>
        <br>

        <!-- GRID PRO KARTY M칈STNOST칈 -->
        <div id="dashboard-rooms" class="dashboard-grid">
            <!-- Karty se generuj칤 automaticky p콏es JS -->
        </div>

        <!-- GRAF -->
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURACE THINGSPEAK ---
        // ZDE ZADEJTE SV칄 칔DAJE
        const tsConfig = {
            channelID: '3011617', 
            readKey: 'BMX38S8R8XSRK5YR'
        };

        // --- 2. KONFIGURACE SENZOR콡 PRO M칈STNOSTI ---
        const senzorKonfig = [
            { 
                id: 'obyvak', 
                nazev: 'Ob칳v치k', 
                fieldTemp: 'field1', // Teplota
                fieldHum: 'field2',  // Vlhkost (dle zad치n칤)
                color: '#3498db'
            }
            // Zde m콢쬰te p콏idat dal코칤 m칤stnosti
        ];

        // --- 3. GENERUJ HTML KARTY ---
        const dashboardRooms = document.getElementById('dashboard-rooms');
        senzorKonfig.forEach(senzor => {
            const html = `
                <div class="card" style="border-top-color: ${senzor.color}">
                    <span class="card-icon">游</span>
                    <h2>${senzor.nazev}</h2>
                    <div class="data-row">
                        <span class="data-label">Teplota</span>
                        <div><span id="val-temp-${senzor.id}" class="data-value">--</span> <span class="data-unit">춿C</span></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Vlhkost</span>
                        <div><span id="val-hum-${senzor.id}" class="data-value">--</span> <span class="data-unit">%</span></div>
                    </div>
                </div>
            `;
            dashboardRooms.innerHTML += html;
        });

        // --- 4. INICIALIZACE GRAFU ---
        const ctx = document.getElementById('tempChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: senzorKonfig.map(s => ({
                    label: s.nazev,
                    borderColor: s.color,
                    backgroundColor: s.color,
                    data: [], 
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0, 
                    pointHitRadius: 10
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour', tooltipFormat: 'HH:mm' },
                        title: { display: true, text: '캛as' }
                    },
                    y: { suggestedMin: 18, suggestedMax: 28 }
                },
                plugins: { 
                    title: { display: true, text: 'V칳voj teplot' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });

        // --- 5. NA캛칈T츼N칈 DAT (REST API) ---
        async function fetchData() {
            if (tsConfig.channelID === 'VLOZTE_CHANNEL_ID') {
                document.getElementById('status').innerText = 'Chyb칤 nastaven칤 Channel ID!';
                document.getElementById('status').style.color = 'red';
                return;
            }

            // Na캜teme posledn칤ch 100 z치znam콢 pro graf
            const url = `https://api.thingspeak.com/channels/${tsConfig.channelID}/feeds.json?api_key=${tsConfig.readKey}&results=100`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.feeds && data.feeds.length > 0) {
                    // 1. Vymaz치n칤 star칳ch dat v grafu
                    myChart.data.datasets.forEach(ds => ds.data = []);

                    // 2. Napln캩n칤 grafu histori칤
                    data.feeds.forEach(feed => {
                        const time = new Date(feed.created_at);
                        senzorKonfig.forEach((senzor, index) => {
                            const val = parseFloat(feed[senzor.fieldTemp]);
                            if (!isNaN(val)) {
                                myChart.data.datasets[index].data.push({x: time, y: val});
                            }
                        });
                    });
                    myChart.update();

                    // 3. Aktualizace 캜칤seln칳ch hodnot z POSLEDN칈HO z치znamu
                    const lastFeed = data.feeds[data.feeds.length - 1];
                    const lastUpdate = new Date(lastFeed.created_at);

                    senzorKonfig.forEach(senzor => {
                        const temp = parseFloat(lastFeed[senzor.fieldTemp]);
                        const hum = parseFloat(lastFeed[senzor.fieldHum]);

                        const elTemp = document.getElementById(`val-temp-${senzor.id}`);
                        const elHum = document.getElementById(`val-hum-${senzor.id}`);

                        if (!isNaN(temp)) elTemp.innerText = temp.toFixed(1);
                        if (!isNaN(hum)) elHum.innerText = hum.toFixed(0);
                    });

                    // Aktualizace statusu
                    document.getElementById('status').innerHTML = 
                        `Posledn칤 aktualizace: ${lastUpdate.toLocaleTimeString()} (REST API)`;
                    document.getElementById('status').style.color = '#7f8c8d';

                } else {
                    document.getElementById('status').innerText = '콯치dn치 data k dispozici.';
                }
            } catch (error) {
                console.error("Chyba p콏i na캜칤t치n칤 dat:", error);
                document.getElementById('status').innerText = 'Chyba p콏ipojen칤 k ThingSpeak API.';
                document.getElementById('status').style.color = 'red';
            }
        }

        // Spustit hned po na캜ten칤
        fetchData();

        // Automatick치 aktualizace ka쬯ou minutu (60000 ms)
        // ThingSpeak free verze m치 limit cca 15s, tak쬰 1 minuta je bezpe캜n치
        setInterval(fetchData, 60000);

    </script>
</body>
</html>