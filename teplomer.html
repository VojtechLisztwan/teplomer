<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel - M√≠stnosti</title>
    <!-- Odkaz na sd√≠len√Ω CSS soubor -->
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
</head>
<body>

    <!-- NAVIGACE -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">Panel Lorda Vojtƒõcha</a>
        <div class="nav-links">
            <a href="teplomer.html" class="nav-btn active">M√≠stnosti</a>
            <a href="kotelna.html" class="nav-btn">Kotelna</a>
        </div>
    </nav>

    <div class="container">
        <div id="status">P≈ôipojov√°n√≠ k MQTT...</div>
        <br>

        <!-- GRID PRO KARTY M√çSTNOST√ç -->
        <div id="dashboard-rooms" class="dashboard-grid">
            <!-- Karty se generuj√≠ automaticky p≈ôes JS -->
        </div>

        <!-- GRAF -->
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURACE SENZOR≈Æ PRO M√çSTNOSTI ---
        const senzorKonfig = [
            { 
                id: 'obyvak', 
                nazev: 'Ob√Ωv√°k', 
                topicTemp: 'doma/obyvak/teplota', 
                topicHum: 'doma/obyvak/vlhkost',
                color: '#3498db',
                // ThingSpeak Field: Do kter√©ho pole (Field 1-8) pos√≠l√°te teplotu z tohoto senzoru?
                thingSpeakField: 'field1' 
            }
            // Pokud p≈ôid√°te dal≈°√≠ senzor, p≈ôi≈ôaƒète mu 'field2', 'field3' atd.
        ];

        // --- 2. KONFIGURACE THINGSPEAK (PRO HISTORII) ---
        // Zde mus√≠te vyplnit √∫daje z va≈°eho √∫ƒçtu na thingspeak.com
        const tsConfig = {
            enabled: true, // Zmƒõ≈àte na true, a≈æ budete m√≠t ThingSpeak nastaven√Ω
            channelID: '3011617', // Nap≈ô. 123456
            readKey: 'BMX38S8R8XSRK5YR'  // Nap≈ô. ABCDEF123456
        };

        // --- 3. MQTT KONFIGURACE (P≈ÆVODN√ç SERVER) ---
        const mqttOptions = {
            protocol: 'wss',
            hostname: 'ode2c9e6.ala.eu-central-1.emqxsl.com', 
            port: 8084,
            path: '/mqtt',
            username: 'web', 
            password: 'webpassword', 
            clientId: 'LordRooms_' + Math.random().toString(16).substr(2, 8)
        };

        // --- 4. GENERUJ HTML KARTY ---
        const dashboardRooms = document.getElementById('dashboard-rooms');
        senzorKonfig.forEach(senzor => {
            const html = `
                <div class="card" style="border-top-color: ${senzor.color}">
                    <span class="card-icon">üè†</span>
                    <h2>${senzor.nazev}</h2>
                    <div class="data-row">
                        <span class="data-label">Teplota</span>
                        <div><span id="val-temp-${senzor.id}" class="data-value">--</span> <span class="data-unit">¬∞C</span></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Vlhkost</span>
                        <div><span id="val-hum-${senzor.id}" class="data-value">--</span> <span class="data-unit">%</span></div>
                    </div>
                </div>
            `;
            dashboardRooms.innerHTML += html;
        });

        // --- 5. INICIALIZACE GRAFU ---
        const ctx = document.getElementById('tempChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: senzorKonfig.map(s => ({
                    label: s.nazev,
                    borderColor: s.color,
                    backgroundColor: s.color,
                    data: [], // Zde se naƒçte historie + nov√° data
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0, // Body nebudou vidƒõt, jen ƒç√°ra (p≈ôehlednƒõj≈°√≠)
                    pointHitRadius: 10
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour', tooltipFormat: 'HH:mm' },
                        title: { display: true, text: 'ƒåas (posledn√≠ch 24h)' }
                    },
                    y: { suggestedMin: 18, suggestedMax: 28 }
                },
                plugins: { 
                    title: { display: true, text: 'V√Ωvoj teplot v ƒçase' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });

        // --- 6. NAƒåTEN√ç HISTORIE Z THINGSPEAK ---
        async function loadHistory() {
            if (!tsConfig.enabled || tsConfig.channelID === 'VLOZTE_CHANNEL_ID') {
                console.log("ThingSpeak nen√≠ nastaven.");
                return;
            }

            const statusEl = document.getElementById('status');
            // St√°hneme 1440 z√°znam≈Ø (pokud pos√≠l√°te 1x za minutu = 24 hodin)
            const url = `https://api.thingspeak.com/channels/${tsConfig.channelID}/feeds.json?api_key=${tsConfig.readKey}&results=1000`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.feeds) {
                    data.feeds.forEach(feed => {
                        const time = new Date(feed.created_at);
                        
                        // Projdeme na≈°e senzory a sp√°rujeme je s Fieldy
                        senzorKonfig.forEach((senzor, index) => {
                            const fieldName = senzor.thingSpeakField; // nap≈ô 'field1'
                            const val = parseFloat(feed[fieldName]);
                            
                            if (!isNaN(val)) {
                                myChart.data.datasets[index].data.push({x: time, y: val});
                            }
                        });
                    });
                    myChart.update();
                    console.log(`Naƒçteno ${data.feeds.length} z√°znam≈Ø historie.`);
                }
            } catch (error) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ historie:", error);
            }
        }

        // Spustit naƒç√≠t√°n√≠ historie po startu
        loadHistory();


        // --- 7. MQTT LOGIKA (≈ΩIV√Å DATA) ---
        const client = mqtt.connect(mqttOptions);
        const statusEl = document.getElementById('status');

        client.on('connect', () => {
            statusEl.innerHTML = '<span class="online">‚óè Online - M√≠stnosti (Priv√°tn√≠ Server)</span>';
            senzorKonfig.forEach(s => {
                client.subscribe(s.topicTemp);
                client.subscribe(s.topicHum);
            });
        });

        client.on('message', (topic, message) => {
            const msgVal = parseFloat(message.toString());
            const now = new Date();

            senzorKonfig.forEach((s, index) => {
                if (topic === s.topicTemp) {
                    const el = document.getElementById(`val-temp-${s.id}`);
                    if(el) el.innerText = msgVal.toFixed(1);
                    
                    // P≈ôid√°n√≠ do grafu (navazujeme na historii)
                    myChart.data.datasets[index].data.push({x: now, y: msgVal});
                    
                    // Aby graf nebyl nekoneƒçn√Ω, ma≈æeme velmi star√° data (dr≈æ√≠me cca 24h p≈ôi minutov√©m intervalu)
                    if (myChart.data.datasets[index].data.length > 2000) {
                        myChart.data.datasets[index].data.shift();
                    }
                    myChart.update('none');

                } else if (topic === s.topicHum) {
                    const el = document.getElementById(`val-hum-${s.id}`);
                    if(el) el.innerText = msgVal.toFixed(0);
                }
            });
        });
        
        client.on('error', (err) => { 
            console.error(err); 
            statusEl.innerText = 'Chyba spojen√≠ s MQTT'; 
            statusEl.style.color = 'red';
        });
    </script>
</body>
</html>